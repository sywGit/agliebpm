"use strict";var activitiModeler=angular.module("activitiModeler",["ngCookies","ngResource","ngSanitize","ngRoute","ngDragDrop","mgcrea.ngStrap","ngGrid","ngAnimate","pascalprecht.translate","duScroll","base","baseDirective","nodeDefModel"]),activitiModule=activitiModeler;activitiModeler.config(["$selectProvider","$translateProvider",function(e,t){angular.extend(e.defaults,{caretHtml:'&nbsp;<i class="icon icon-caret-down"></i>'}),t.useStaticFilesLoader({prefix:"./editor-app/i18n/",suffix:".json"}),t.preferredLanguage("zh-CN"),t.useCookieStorage()}]).run(["$rootScope","$timeout","$modal","$translate","$location","$window","$http","$q",function(m,s,e,t,n,l,a,i){m.config=ACTIVITI.CONFIG,m.editorInitialized=!1,m.editorFactory=i.defer(),m.forceSelectionRefresh=!1,m.ignoreChanges=!1,m.validationErrors=[],m.staticIncludeVersion=Date.now(),m.safeApply=function(e){var t=this.$root.$$phase;"$apply"==t||"$digest"==t?e&&"function"==typeof e&&e():this.$apply(e)},m.$on("$includeContentLoaded",function(e){if(!m.editorInitialized){ORYX._loadPlugins();var t=EDITOR.UTIL.getParameterByName("modelId");o=t,r=KISBPM.URL.getModel(o),a({method:"GET",url:r}).success(function(e,t,n,i){m.editor=new ORYX.Editor(e),m.modelData=angular.fromJson(e),m.$broadcast("bpmDefSetting",m.modelData.bpmDefSetting),m.editorFactory.resolve()}).error(function(e,t,n,i){console.log("Error loading model with id "+o+" "+e)}),m.window={};var n=function(){m.window.width=l.innerWidth,m.window.height=l.innerHeight};angular.element(l).bind("resize",function(){m.safeApply(n())}),m.$watch("window.forceRefresh",function(e){e&&s(function(){n(),m.window.forceRefresh=!1})}),n(),jQuery(window).resize(function(){var e=jQuery("#editor-header").offset(),t=jQuery("#propertySection").height()+36,n=jQuery("#canvasSection"),i=jQuery("#main-header");if(null!=e&&null!==e&&null!=t&&null!=n&&null!==i){if(m.editor){var o=m.editor.selection,r=m.editor._subSelection;m.selectedElements=o,m.subSelectionElements=r,o&&0<o.length&&(m.selectedElementBeforeScrolling=o[0],m.editor.setSelection([]),m.editor.setSelection(m.selectedElements,m.subSelectionElements),m.selectedElements=void 0,m.subSelectionElements=void 0)}var s=jQuery(window).height()-e.top-i.height()-21;n.height(s-t),jQuery("#paletteSection").height(s);var l=null;n&&n[0].children[1]&&(l=n[0].children[1]);var a=n.position().top,c=n.position().left,u=n[0].clientHeight,d=n[0].clientWidth,p=0,y=0;l&&(y=l.clientWidth||l.parentNode.clientWidth),y<n[0].clientWidth&&(c-=(p=y-n[0].clientWidth)/2,d+=p);var f=jQuery("#canvas-grow-N");f.css("top",a+20+"px"),f.css("left",c-10+(d-17)/2+"px");var h=jQuery("#canvas-grow-S");h.css("top",a+u-20-8+"px"),h.css("left",c-10+(d-17)/2+"px");var E=jQuery("#canvas-grow-E");E.css("top",a-10+(u-17)/2+"px"),E.css("left",c+d-20-8+"px");var g=jQuery("#canvas-grow-W");g.css("top",a-10+(u-17)/2+"px"),g.css("left",c+20+"px"),(f=jQuery("#canvas-shrink-N")).css("top",a+20+"px"),f.css("left",c+10+(d-17)/2+"px"),(h=jQuery("#canvas-shrink-S")).css("top",a+u-20-8+"px"),h.css("left",c+10+(d-17)/2+"px"),(E=jQuery("#canvas-shrink-E")).css("top",a+10+(u-17)/2+"px"),E.css("left",c+d-20-8+"px"),(g=jQuery("#canvas-shrink-W")).css("top",a+10+(u-17)/2+"px"),g.css("left",c+20+"px")}}),jQuery(window).trigger("resize"),jQuery.fn.scrollStopped=function(t){jQuery(this).scroll(function(){var e=jQuery(this);e.data("scrollTimeout")&&clearTimeout(e.data("scrollTimeout")),e.data("scrollTimeout",setTimeout(t,50,this))})},(i=jQuery("#flowDesigner")).scroll(function(){var e=m.editor.selection,t=m.editor._subSelection;m.selectedElements=e,m.subSelectionElements=t,e&&0<e.length&&(m.selectedElementBeforeScrolling=e[0]),jQuery(".Oryx_button").each(function(e,t){m.orginalOryxButtonStyle=t.style.display,t.style.display="none"}),jQuery(".resizer_southeast").each(function(e,t){m.orginalResizerSEStyle=t.style.display,t.style.display="none"}),jQuery(".resizer_northwest").each(function(e,t){m.orginalResizerNWStyle=t.style.display,t.style.display="none"}),m.editor.handleEvents({type:ORYX.CONFIG.EVENT_CANVAS_SCROLL})}),i.scrollStopped(function(){function n(e){0<jQuery(e).position().top?e.style.display="block":e.style.display="none"}m.editor.setSelection([]),m.editor.setSelection(m.selectedElements,m.subSelectionElements),m.selectedElements=void 0,m.subSelectionElements=void 0,jQuery(".Oryx_button").each(function(e,t){n(t)}),jQuery(".resizer_southeast").each(function(e,t){n(t)}),jQuery(".resizer_northwest").each(function(e,t){n(t)})}),m.editorInitialized=!0}var i,o,r}),m.editorFactory.promise.then(function(){KISBPM.eventBus.editor=m.editor,[{oryxType:ORYX.CONFIG.EVENT_SELECTION_CHANGED,kisBpmType:KISBPM.eventBus.EVENT_TYPE_SELECTION_CHANGE},{oryxType:ORYX.CONFIG.EVENT_DBLCLICK,kisBpmType:KISBPM.eventBus.EVENT_TYPE_DOUBLE_CLICK},{oryxType:ORYX.CONFIG.EVENT_MOUSEOUT,kisBpmType:KISBPM.eventBus.EVENT_TYPE_MOUSE_OUT},{oryxType:ORYX.CONFIG.EVENT_MOUSEOVER,kisBpmType:KISBPM.eventBus.EVENT_TYPE_MOUSE_OVER}].forEach(function(t){m.editor.registerOnEvent(t.oryxType,function(e){KISBPM.eventBus.dispatch(t.kisBpmType,e)})}),m.editor.registerOnEvent(ORYX.CONFIG.EVENT_SHAPEREMOVED,function(e){var t=document.getElementById(e.shape.resourceId+"-validate-button");t&&(t.style.display="none")}),KISBPM.eventBus.dispatch(KISBPM.eventBus.EVENT_TYPE_EDITOR_READY,{type:KISBPM.eventBus.EVENT_TYPE_EDITOR_READY})}),m.alerts={queue:[]},m.showAlert=function(e){0<e.queue.length?(e.current=e.queue.shift(),e.timeout=s(function(){0==e.queue.length?(e.current=void 0,e.timeout=void 0):m.showAlert(e)},"error"==e.current.type?5e3:1e3)):m.alerts.current=void 0},m.addAlert=function(e,t){var n={message:e,type:t};m.alerts.timeout?m.alerts.queue.push(n):(m.alerts.queue.push(n),m.showAlert(m.alerts))},m.dismissAlert=function(){m.alerts.timeout?(s.cancel(m.alerts.timeout),m.alerts.timeout=void 0,m.showAlert(m.alerts)):m.alerts.current=void 0},m.addAlertPromise=function(e,t){e&&e.then(function(e){m.addAlert(e,t)})}}]).filter("dateformat",function(){return function(e,t){return e?t?moment(e).format(t):moment(e).calendar():""}}),String.prototype.startWith=function(e,t){if(null==e||""==e||0==this.length||e.length>this.length)return!1;var n=this.substr(0,e.length);return null==t||t?n==e:n.toLowerCase()==e.toLowerCase()};